<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tailor Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            background: #f4f6f9;
            color: #333;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(to right, #6a5acd, #7b68ee);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        header h1 {
            font-size: 1.8rem;
        }

        .menu-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .menu-dropdown {
            position: absolute;
            top: 70px;
            right: 20px;
            background: white;
            color: #333;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            width: 200px;
            display: none;
            z-index: 100;
        }

        .menu-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .menu-item:hover {
            background: #f8f9fa;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #666;
        }

        .tab.active {
            background: white;
            color: #6a5acd;
            border-bottom: 3px solid #6a5acd;
        }

        .tab-content {
            padding: 20px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #6a5acd;
            outline: none;
        }

        .btn {
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        .btn-primary {
            background: #6a5acd;
            color: white;
        }

        .btn-secondary {
            background: #888;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-small {
            width: auto;
            padding: 8px 16px;
            font-size: 0.9rem;
            display: inline-block;
            margin: 5px;
        }

        .measurements-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .measurement-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #eee;
        }

        .section-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
        }

        .measurement-row {
            display: flex;
            margin-bottom: 12px;
            align-items: center;
        }

        .measurement-label {
            width: 120px;
            font-weight: 600;
        }

        .measurement-input {
            flex: 1;
        }

        .order-item-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid #6a5acd;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: #6a5acd;
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.4rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .sub-tabs {
            display: flex;
            margin: 20px 0;
        }

        .sub-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: #f0f0f0;
            cursor: pointer;
        }

        .sub-tab.active {
            background: white;
            border-bottom: 3px solid #6a5acd;
            font-weight: bold;
        }

        .alert-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: none;
            z-index: 1001;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        footer {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            color: #666;
            font-size: 0.9rem;
        }

        .photo-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px solid #ddd;
        }

        .billing-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #e9ecef;
        }

        .bill-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .bill-header {
            font-weight: bold;
            background: #f0f0f0;
        }

        .bill-total {
            font-size: 1.2rem;
            font-weight: bold;
            color: #28a745;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #6a5acd;
        }

        .priority-high {
            border-left: 5px solid #dc3545;
        }

        .priority-medium {
            border-left: 5px solid #ffc107;
        }

        .priority-low {
            border-left: 5px solid #28a745;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-billed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .emergency-orders {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        .emergency-header {
            font-weight: bold;
            color: #856404;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        @media (max-width: 768px) {
            .measurements-container {
                grid-template-columns: 1fr;
            }
            .measurement-row {
                flex-direction: column;
                align-items: stretch;
            }
            .measurement-label {
                margin-bottom: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üëó Tailor Management System</h1>
            <p>Customers ‚Ä¢ Measurements ‚Ä¢ Orders ‚Ä¢ Billing</p>
            <button class="menu-btn" onclick="toggleMenu()">‚ãÆ</button>
            <div class="menu-dropdown" id="menuDropdown">
                <div class="menu-item" onclick="openAllOrdersModal()">üìã View All Orders</div>
                <div class="menu-item" onclick="openBillingModal()">üí∞ Generate Bill</div>
                <div class="menu-item" onclick="showEmergencyOrders()">üö® Emergency Orders</div>
            </div>
        </header>

        <div class="alert-notification" id="urgentAlert">
            <strong><span id="urgentCount">0</span> Urgent Orders Due Soon!</strong>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('customers')">Customers</div>
            <div class="tab" onclick="switchTab('orders')">New Order</div>
            <div class="tab" onclick="switchTab('search')">Search Orders</div>
        </div>

        <!-- Customers Tab -->
        <div id="customers" class="tab-content active">
            <h2 style="margin-bottom:20px;">Add / Edit Customer</h2>
            <form id="customerForm">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="custName" required>
                </div>
                <div class="form-group">
                    <label>Phone *</label>
                    <input type="tel" id="custPhone" required>
                </div>

                <div class="measurements-container">
                    <div class="measurement-section">
                        <div class="section-title">üëö Kurti / Dress</div>
                        <div class="measurement-row"><div class="measurement-label">Length</div><input type="text" class="measurement-input" id="k_length"></div>
                        <div class="measurement-row"><div class="measurement-label">Chest</div><input type="text" class="measurement-input" id="k_chest"></div>
                        <div class="measurement-row"><div class="measurement-label">Waist</div><input type="text" class="measurement-input" id="k_waist"></div>
                        <div class="measurement-row"><div class="measurement-label">Hips</div><input type="text" class="measurement-input" id="k_hips"></div>
                        <div class="measurement-row"><div class="measurement-label">Shoulder</div><input type="text" class="measurement-input" id="k_shoulder"></div>
                        <div class="measurement-row"><div class="measurement-label">Sleeves</div><input type="text" class="measurement-input" id="k_sleeves"></div>
                        <div class="measurement-row"><div class="measurement-label">Neck</div><input type="text" class="measurement-input" id="k_neck"></div>
                        <div class="measurement-row"><div class="measurement-label">Cut</div><input type="text" class="measurement-input" id="k_cut" placeholder="A-line, Straight"></div>
                        <div class="measurement-row"><div class="measurement-label">Gher (‡™ò‡´á‡™∞)</div><input type="text" class="measurement-input" id="k_gher"></div>
                    </div>
                    <div class="measurement-section">
                        <div class="section-title">üëñ Salwar / Pant</div>
                        <div class="measurement-row"><div class="measurement-label">Mori</div><input type="text" class="measurement-input" id="s_mori"></div>
                        <div class="measurement-row"><div class="measurement-label">Length</div><input type="text" class="measurement-input" id="s_length"></div>
                        <div class="measurement-row"><div class="measurement-label">Pindi</div><input type="text" class="measurement-input" id="s_pindi"></div>
                        <div class="measurement-row"><div class="measurement-label">Knee</div><input type="text" class="measurement-input" id="s_knee"></div>
                        <div class="measurement-row"><div class="measurement-label">Thai</div><input type="text" class="measurement-input" id="s_thai"></div>
                        <div class="measurement-row"><div class="measurement-label">Deep Thai</div><input type="text" class="measurement-input" id="s_deep_thai"></div>
                    </div>
                    <div class="measurement-section">
                        <div class="section-title">üëï Blouse</div>
                        <div class="measurement-row"><div class="measurement-label">Length</div><input type="text" class="measurement-input" id="b_length"></div>
                        <div class="measurement-row"><div class="measurement-label">Upper Chest</div><input type="text" class="measurement-input" id="b_upper_chest"></div>
                        <div class="measurement-row"><div class="measurement-label">Chest</div><input type="text" class="measurement-input" id="b_chest"></div>
                        <div class="measurement-row"><div class="measurement-label">Kamar</div><input type="text" class="measurement-input" id="b_kamar"></div>
                        <div class="measurement-row"><div class="measurement-label">Shoulder</div><input type="text" class="measurement-input" id="b_shoulder"></div>
                        <div class="measurement-row"><div class="measurement-label">Sleeves</div><input type="text" class="measurement-input" id="b_sleeves"></div>
                        <div class="measurement-row"><div class="measurement-label">Neck</div><input type="text" class="measurement-input" id="b_neck"></div>
                    </div>
                </div>

                <input type="hidden" id="editCustId">
                <button type="submit" class="btn btn-primary">Save Customer</button>
                <button type="button" class="btn btn-secondary" onclick="clearCustomerForm()">Clear</button>
            </form>

            <h2 style="margin:40px 0 20px;">Search Customers</h2>
            <input type="text" id="searchCust" placeholder="Name or phone..." style="padding:12px; width:100%; margin-bottom:20px;">
            <div id="searchResults"></div>
        </div>

        <!-- New Order Tab -->
        <div id="orders" class="tab-content">
            <h2>New Order</h2>
            <div class="form-group">
                <label>Select Customer</label>
                <input type="text" id="orderCustSearch" placeholder="Search customer..." oninput="searchOrderCustomers()">
                <div id="orderCustResults" style="max-height:200px; overflow-y:auto; background:white; border:1px solid #ddd; margin-top:10px; display:none;"></div>
            </div>

            <div id="selectedCustomer" style="background:#f0f8ff; padding:15px; border-radius:10px; margin:20px 0; display:none;">
                <strong id="selCustName"></strong> (<span id="selCustPhone"></span>)
                <button class="btn btn-danger btn-small" onclick="clearSelectedCustomer()" style="float:right;">Change</button>
            </div>

            <div id="addGarmentSection" style="display:none;">
                <h3>Add Garment</h3>
                <select id="garmentType">
                    <option value="">Select Garment</option>
                    <option value="kurti">Kurti</option>
                    <option value="blouse">Blouse</option>
                    <option value="pant">Pant</option>
                    <option value="salwar">Salwar</option>
                    <option value="dress">Dress</option>
                </select>
                
                <div class="form-group" style="margin-top:15px;">
                    <label>Quantity</label>
                    <input type="number" id="garmentQty" value="1" min="1">
                </div>
                
                <div class="form-group">
                    <label>Special Instructions</label>
                    <textarea id="garmentNote" placeholder="Any special instructions"></textarea>
                </div>
                
                <button class="btn btn-success" onclick="addToOrder()" style="margin-top:15px;">Add to Order</button>
            </div>

            <div id="orderItems" style="margin:30px 0;"></div>

            <div id="orderDetails" style="display:none;">
                <h3>Order Details</h3>
                <div class="form-group">
                    <label>Delivery Date *</label>
                    <input type="date" id="deliveryDate">
                </div>
                <div class="form-group">
                    <label>Priority</label>
                    <select id="orderPriority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="orderNotes"></textarea>
                </div>
                <button class="btn btn-primary" onclick="saveOrder()">Place Order</button>
            </div>
        </div>

        <!-- Search Orders Tab -->
        <div id="search" class="tab-content">
            <h2>Search Orders</h2>
            <input type="text" id="searchOrdersInput" placeholder="Search by customer name, phone, order ID, or garment type..." style="padding:12px; width:100%; margin-bottom:20px;" oninput="searchAllOrders()">
            
            <div class="sub-tabs">
                <div class="sub-tab active" onclick="filterOrders('all')">All Orders</div>
                <div class="sub-tab" onclick="filterOrders('pending')">Pending</div>
                <div class="sub-tab" onclick="filterOrders('completed')">Completed</div>
                <div class="sub-tab" onclick="filterOrders('billed')">Billed</div>
            </div>
            
            <!-- Emergency Orders Section -->
            <div id="emergencyOrdersSection" style="display:none;">
                <div class="emergency-orders">
                    <div class="emergency-header">üö® EMERGENCY ORDERS (Due within 3 days)</div>
                    <div id="emergencyOrdersList"></div>
                </div>
            </div>
            
            <div id="searchOrdersResults" style="margin-top:20px;"></div>
        </div>

        <footer>Made with ‚ù§Ô∏è for Tailors ‚Ä¢ Local Storage</footer>
    </div>

    <!-- All Orders Modal -->
    <div class="modal-overlay" id="allOrdersModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>All Orders</h3>
                <button class="modal-close" onclick="closeModal('allOrdersModal')">√ó</button>
            </div>
            <div class="modal-body">
                <input type="text" id="ordersSearch" placeholder="Search by customer name or phone..." style="width:100%; padding:12px; margin-bottom:20px;" oninput="filterModalOrders()">
                <div class="sub-tabs">
                    <div class="sub-tab active" onclick="filterModalOrders('pending')">Pending</div>
                    <div class="sub-tab" onclick="filterModalOrders('completed')">Completed</div>
                    <div class="sub-tab" onclick="filterModalOrders('billed')">Billed</div>
                </div>
                <div id="allOrdersList"></div>
            </div>
        </div>
    </div>

    <!-- Edit Order Modal -->
    <div class="modal-overlay" id="editOrderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Order</h3>
                <button class="modal-close" onclick="closeModal('editOrderModal')">√ó</button>
            </div>
            <div class="modal-body" id="editOrderContent">
                <!-- Edit order content will be generated here -->
            </div>
        </div>
    </div>

    <!-- Emergency Orders Modal -->
    <div class="modal-overlay" id="emergencyOrdersModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üö® Emergency Orders (Due within 3 days)</h3>
                <button class="modal-close" onclick="closeModal('emergencyOrdersModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="emergencyModalList"></div>
            </div>
        </div>
    </div>

    <!-- Item Billing Modal -->
    <div class="modal-overlay" id="itemBillingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Bill Item: <span id="currentItemTitle"></span></h3>
                <button class="modal-close" onclick="closeModal('itemBillingModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="itemBillingContent"></div>
                <div style="text-align:center; margin-top:30px;">
                    <button class="btn btn-success" onclick="saveItemBilling()">Save & Continue</button>
                    <button class="btn btn-secondary" onclick="closeModal('itemBillingModal')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Final Billing Modal -->
    <div class="modal-overlay" id="finalBillingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Final Bill</h3>
                <button class="modal-close" onclick="closeModal('finalBillingModal')">√ó</button>
            </div>
            <div class="modal-body" id="finalBillContent">
                <!-- Bill content will be generated here -->
            </div>
        </div>
    </div>

    <!-- Billing Modal -->
    <div class="modal-overlay" id="billingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Generate Bill</h3>
                <button class="modal-close" onclick="closeModal('billingModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="billingOrdersList"></div>
            </div>
        </div>
    </div>

    <script>
        // Initialize data
        let customers = JSON.parse(localStorage.getItem('tailor_customers') || '[]');
        let orders = JSON.parse(localStorage.getItem('tailor_orders') || '[]');
        let currentOrder = { customer: null, items: [] };
        let editingCustomerId = null;
        let currentBillingOrder = null;
        let currentBillingItemIndex = 0;
        let billingData = {};
        let currentOrderFilter = 'all';
        let editingOrderId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            searchCustomers();
            updateUrgentAlert();
            searchAllOrders();
            showEmergencyOrders();
            
            // Set minimum date for delivery
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('deliveryDate').min = today;
        });

        // Tab switching
        function switchTab(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // If switching to search tab, load orders
            if (tabName === 'search') {
                searchAllOrders();
                showEmergencyOrders();
            }
        }

        // Menu
        function toggleMenu() {
            const menu = document.getElementById('menuDropdown');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
        
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.menu-btn') && !e.target.closest('.menu-dropdown')) {
                document.getElementById('menuDropdown').style.display = 'none';
            }
        });

        // Customer Save
        document.getElementById('customerForm').onsubmit = function(e) {
            e.preventDefault();
            const name = document.getElementById('custName').value.trim();
            const phone = document.getElementById('custPhone').value.trim();
            if (!name || !phone) {
                alert('Name and phone required');
                return;
            }

            const cust = {
                id: editingCustomerId || Date.now(),
                name: name,
                phone: phone,
                kurti: { 
                    length: document.getElementById('k_length').value, 
                    chest: document.getElementById('k_chest').value, 
                    waist: document.getElementById('k_waist').value, 
                    hips: document.getElementById('k_hips').value, 
                    shoulder: document.getElementById('k_shoulder').value, 
                    sleeves: document.getElementById('k_sleeves').value,
                    neck: document.getElementById('k_neck').value,
                    cut: document.getElementById('k_cut').value,
                    gher: document.getElementById('k_gher').value
                },
                salwar: { 
                    mori: document.getElementById('s_mori').value,
                    length: document.getElementById('s_length').value, 
                    pindi: document.getElementById('s_pindi').value,
                    knee: document.getElementById('s_knee').value,
                    thai: document.getElementById('s_thai').value,
                    deep_thai: document.getElementById('s_deep_thai').value
                },
                blouse: { 
                    length: document.getElementById('b_length').value, 
                    upper_chest: document.getElementById('b_upper_chest').value,
                    chest: document.getElementById('b_chest').value, 
                    kamar: document.getElementById('b_kamar').value,
                    shoulder: document.getElementById('b_shoulder').value,
                    sleeves: document.getElementById('b_sleeves').value,
                    neck: document.getElementById('b_neck').value
                }
            };

            if (editingCustomerId) {
                const idx = customers.findIndex(c => c.id === editingCustomerId);
                if (idx !== -1) {
                    customers[idx] = cust;
                }
            } else {
                customers.push(cust);
            }

            localStorage.setItem('tailor_customers', JSON.stringify(customers));
            alert('Customer saved!');
            clearCustomerForm();
            searchCustomers();
        };

        function clearCustomerForm() {
            document.getElementById('customerForm').reset();
            editingCustomerId = null;
            document.getElementById('editCustId').value = '';
        }

        // Search Customers
        document.getElementById('searchCust').oninput = searchCustomers;
        
        function searchCustomers() {
            const term = document.getElementById('searchCust').value.toLowerCase();
            const results = document.getElementById('searchResults');
            const filtered = customers.filter(c => 
                c.name.toLowerCase().includes(term) || 
                c.phone.includes(term)
            );
            
            if (filtered.length === 0) {
                results.innerHTML = '<div class="empty-state">No customers found</div>';
                return;
            }
            
            results.innerHTML = filtered.map(c => `
                <div class="order-item-card">
                    <strong>${c.name}</strong> - ${c.phone}
                    <button class="btn btn-small btn-primary" style="float:right;" onclick="editCustomer('${c.id}')">Edit</button>
                </div>
            `).join('');
        }

        function editCustomer(id) {
            const c = customers.find(x => x.id == id);
            if (!c) return;
            
            document.getElementById('custName').value = c.name;
            document.getElementById('custPhone').value = c.phone;
            
            // Fill kurti measurements
            if (c.kurti) {
                document.getElementById('k_length').value = c.kurti.length || '';
                document.getElementById('k_chest').value = c.kurti.chest || '';
                document.getElementById('k_waist').value = c.kurti.waist || '';
                document.getElementById('k_hips').value = c.kurti.hips || '';
                document.getElementById('k_shoulder').value = c.kurti.shoulder || '';
                document.getElementById('k_sleeves').value = c.kurti.sleeves || '';
                document.getElementById('k_neck').value = c.kurti.neck || '';
                document.getElementById('k_cut').value = c.kurti.cut || '';
                document.getElementById('k_gher').value = c.kurti.gher || '';
            }
            
            // Fill salwar measurements
            if (c.salwar) {
                document.getElementById('s_mori').value = c.salwar.mori || '';
                document.getElementById('s_length').value = c.salwar.length || '';
                document.getElementById('s_pindi').value = c.salwar.pindi || '';
                document.getElementById('s_knee').value = c.salwar.knee || '';
                document.getElementById('s_thai').value = c.salwar.thai || '';
                document.getElementById('s_deep_thai').value = c.salwar.deep_thai || '';
            }
            
            // Fill blouse measurements
            if (c.blouse) {
                document.getElementById('b_length').value = c.blouse.length || '';
                document.getElementById('b_upper_chest').value = c.blouse.upper_chest || '';
                document.getElementById('b_chest').value = c.blouse.chest || '';
                document.getElementById('b_kamar').value = c.blouse.kamar || '';
                document.getElementById('b_shoulder').value = c.blouse.shoulder || '';
                document.getElementById('b_sleeves').value = c.blouse.sleeves || '';
                document.getElementById('b_neck').value = c.blouse.neck || '';
            }
            
            editingCustomerId = c.id;
            switchTab('customers');
        }

        // Order Customer Search
        function searchOrderCustomers() {
            const term = document.getElementById('orderCustSearch').value.toLowerCase();
            const results = document.getElementById('orderCustResults');
            const filtered = customers.filter(c => 
                c.name.toLowerCase().includes(term) || 
                c.phone.includes(term)
            );
            
            if (filtered.length === 0) {
                results.innerHTML = '<div style="padding:10px; color:#777;">No customers found</div>';
                results.style.display = 'block';
                return;
            }
            
            results.innerHTML = filtered.map(c => `
                <div style="padding:10px; border-bottom:1px solid #eee; cursor:pointer;" onclick="selectCustomer(${c.id})">
                    ${c.name} - ${c.phone}
                </div>
            `).join('');
            results.style.display = 'block';
        }

        function selectCustomer(id) {
            const c = customers.find(x => x.id == id);
            if (!c) return;
            
            currentOrder.customer = c;
            document.getElementById('selCustName').textContent = c.name;
            document.getElementById('selCustPhone').textContent = c.phone;
            document.getElementById('selectedCustomer').style.display = 'block';
            document.getElementById('addGarmentSection').style.display = 'block';
            document.getElementById('orderCustResults').style.display = 'none';
            document.getElementById('orderCustSearch').value = '';
        }

        function clearSelectedCustomer() {
            currentOrder = { customer: null, items: [] };
            document.getElementById('selectedCustomer').style.display = 'none';
            document.getElementById('addGarmentSection').style.display = 'none';
            document.getElementById('orderItems').innerHTML = '';
            document.getElementById('orderDetails').style.display = 'none';
            document.getElementById('orderCustSearch').value = '';
        }

        // Add garment to order
        function addToOrder() {
            const type = document.getElementById('garmentType').value;
            if (!type) {
                alert('Select garment type');
                return;
            }
            
            const quantity = parseInt(document.getElementById('garmentQty').value) || 1;
            const note = document.getElementById('garmentNote').value;
            
            currentOrder.items.push({
                type: type,
                quantity: quantity,
                note: note,
                addedAt: new Date().toLocaleString()
            });
            
            // Reset form
            document.getElementById('garmentType').value = '';
            document.getElementById('garmentQty').value = '1';
            document.getElementById('garmentNote').value = '';
            
            displayOrderItems();
            document.getElementById('orderDetails').style.display = 'block';
        }

        function displayOrderItems() {
            const container = document.getElementById('orderItems');
            
            if (currentOrder.items.length === 0) {
                container.innerHTML = '<p>No items added yet</p>';
                return;
            }
            
            container.innerHTML = currentOrder.items.map((item, i) => {
                return `
                    <div class="order-item-card">
                        <strong>${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</strong>
                        <div style="margin-top:10px; font-size:0.9em; color:#555;">
                            Quantity: ${item.quantity}<br>
                            ${item.note ? `Note: ${item.note}<br>` : ''}
                        </div>
                        <button class="btn btn-danger btn-small" style="margin-top:10px;" onclick="removeOrderItem(${i})">Remove</button>
                    </div>
                `;
            }).join('');
        }

        function removeOrderItem(index) {
            currentOrder.items.splice(index, 1);
            displayOrderItems();
            
            if (currentOrder.items.length === 0) {
                document.getElementById('orderDetails').style.display = 'none';
            }
        }

        function saveOrder() {
            if (!currentOrder.customer) {
                alert('Select customer');
                return;
            }
            if (currentOrder.items.length === 0) {
                alert('Add items');
                return;
            }
            if (!document.getElementById('deliveryDate').value) {
                alert('Select delivery date');
                return;
            }

            const order = {
                id: editingOrderId || Date.now(),
                customerId: currentOrder.customer.id,
                customerName: currentOrder.customer.name,
                customerPhone: currentOrder.customer.phone,
                items: currentOrder.items,
                deliveryDate: document.getElementById('deliveryDate').value,
                priority: document.getElementById('orderPriority').value,
                notes: document.getElementById('orderNotes').value,
                status: 'pending',
                created: new Date().toLocaleDateString(),
                createdTimestamp: new Date().toISOString()
            };
            
            if (editingOrderId) {
                // Update existing order
                const idx = orders.findIndex(o => o.id === editingOrderId);
                if (idx !== -1) {
                    orders[idx] = order;
                }
                alert('Order updated!');
            } else {
                // Add new order
                orders.push(order);
                alert('Order placed!');
            }
            
            localStorage.setItem('tailor_orders', JSON.stringify(orders));
            clearSelectedCustomer();
            document.getElementById('deliveryDate').value = '';
            document.getElementById('orderNotes').value = '';
            document.getElementById('orderPriority').value = 'medium';
            editingOrderId = null;
            updateUrgentAlert();
            searchAllOrders();
            showEmergencyOrders();
        }

        // Search Orders - FIXED to show all pending orders by default
        function searchAllOrders() {
            const term = document.getElementById('searchOrdersInput').value.toLowerCase();
            const results = document.getElementById('searchOrdersResults');
            
            let filteredOrders = orders;
            
            // First apply status filter
            if (currentOrderFilter !== 'all') {
                filteredOrders = filteredOrders.filter(o => o.status === currentOrderFilter);
            }
            
            // Then apply search term filter (only if there's a search term)
            if (term) {
                filteredOrders = filteredOrders.filter(o => 
                    (o.customerName && o.customerName.toLowerCase().includes(term)) || 
                    (o.customerPhone && o.customerPhone.includes(term)) ||
                    (o.id && o.id.toString().includes(term)) || // Search by order ID
                    (o.items && o.items.some(item => item.type && item.type.toLowerCase().includes(term))) // Search by garment type
                );
            }
            
            // Sort orders based on priority and delivery date
            filteredOrders.sort((a, b) => {
                // First sort by priority
                const priorityOrder = { 'high': 3, 'medium': 2, 'low': 1 };
                const priorityDiff = (priorityOrder[b.priority] || 1) - (priorityOrder[a.priority] || 1);
                
                if (priorityDiff !== 0) return priorityDiff;
                
                // Then sort by delivery date (soonest first)
                const dateA = new Date(a.deliveryDate);
                const dateB = new Date(b.deliveryDate);
                
                // For pending orders, sort by delivery date
                if (a.status === 'pending' && b.status === 'pending') {
                    return dateA - dateB;
                }
                
                // For other statuses, sort by creation date (newest first)
                const createdA = new Date(a.createdTimestamp || a.id);
                const createdB = new Date(b.createdTimestamp || b.id);
                return createdB - createdA;
            });
            
            if (filteredOrders.length === 0) {
                results.innerHTML = '<div class="empty-state">No orders found</div>';
                return;
            }
            
            results.innerHTML = filteredOrders.map(o => {
                // Calculate days until delivery for pending orders
                let daysUntil = '';
                let priorityClass = '';
                if (o.status === 'pending' && o.deliveryDate) {
                    const today = new Date();
                    const delivery = new Date(o.deliveryDate);
                    const diffTime = delivery - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays < 0) {
                        daysUntil = ` <span style="color:red; font-weight:bold;">(${Math.abs(diffDays)} days overdue!)</span>`;
                    } else if (diffDays <= 3) {
                        daysUntil = ` <span style="color:orange; font-weight:bold;">(${diffDays} days left)</span>`;
                    } else {
                        daysUntil = ` (${diffDays} days)`;
                    }
                    
                    // Set priority class for pending orders
                    priorityClass = `priority-${o.priority || 'medium'}`;
                }
                
                let statusBadge = '';
                if (o.status === 'pending') {
                    statusBadge = '<span class="status-badge status-pending">PENDING</span>';
                } else if (o.status === 'completed') {
                    statusBadge = '<span class="status-badge status-completed">COMPLETED</span>';
                } else if (o.status === 'billed') {
                    statusBadge = '<span class="status-badge status-billed">BILLED</span>';
                }
                
                return `
                    <div class="order-item-card ${priorityClass}">
                        <strong>${o.customerName}</strong> - ${o.customerPhone}
                        ${statusBadge}
                        <br>
                        Order #${o.id.toString().slice(-6)} | Delivery: ${o.deliveryDate}${daysUntil}<br>
                        ${o.priority ? `Priority: <strong>${o.priority.toUpperCase()}</strong><br>` : ''}
                        Items: ${o.items.map(i => `${i.type} (x${i.quantity || 1})`).join(', ')}<br>
                        <div style="margin-top:5px; font-size:0.9em; color:#666;">
                            Created: ${o.created || new Date(o.id).toLocaleDateString()}
                        </div>
                        <div style="margin-top:10px;">
                            ${o.status === 'pending' ? 
                                `<button class="btn btn-success btn-small" onclick="completeOrder(${o.id})">Mark Completed</button>
                                 <button class="btn btn-warning btn-small" onclick="editExistingOrder(${o.id})">Edit Order</button>` :
                                o.status === 'completed' ?
                                `<button class="btn btn-primary btn-small" onclick="startBillingProcess(${o.id})">Generate Bill</button>` : ''
                            }
                            <button class="btn btn-secondary btn-small" onclick="viewOrderDetails(${o.id})">View Details</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterOrders(status) {
            // Update active tab
            document.querySelectorAll('#search .sub-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            currentOrderFilter = status;
            searchAllOrders();
            showEmergencyOrders();
        }

        function completeOrder(id) {
            const order = orders.find(o => o.id === id);
            if (!order) return;
            
            order.status = 'completed';
            localStorage.setItem('tailor_orders', JSON.stringify(orders));
            searchAllOrders();
            showEmergencyOrders();
            updateUrgentAlert();
            alert('Order marked as completed!');
        }

        // Edit Existing Order
        function editExistingOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            editingOrderId = orderId;
            
            // Find customer
            const customer = customers.find(c => c.id == order.customerId);
            if (customer) {
                currentOrder.customer = customer;
                document.getElementById('selCustName').textContent = customer.name;
                document.getElementById('selCustPhone').textContent = customer.phone;
                document.getElementById('selectedCustomer').style.display = 'block';
                document.getElementById('addGarmentSection').style.display = 'block';
            }
            
            // Set order items
            currentOrder.items = [...order.items];
            displayOrderItems();
            
            // Set order details
            document.getElementById('deliveryDate').value = order.deliveryDate;
            document.getElementById('orderPriority').value = order.priority || 'medium';
            document.getElementById('orderNotes').value = order.notes || '';
            document.getElementById('orderDetails').style.display = 'block';
            
            // Switch to New Order tab
            switchTab('orders');
        }

        // Show Emergency Orders
        function showEmergencyOrders() {
            const emergencySection = document.getElementById('emergencyOrdersSection');
            const emergencyList = document.getElementById('emergencyOrdersList');
            
            // Get today and 3 days from now
            const today = new Date();
            const threeDaysFromNow = new Date();
            threeDaysFromNow.setDate(today.getDate() + 3);
            
            // Find emergency orders (pending, due within 3 days, or overdue)
            const emergencyOrders = orders.filter(o => {
                if (o.status !== 'pending') return false;
                if (!o.deliveryDate) return false;
                
                const deliveryDate = new Date(o.deliveryDate);
                const isOverdue = deliveryDate < today;
                const isWithin3Days = deliveryDate <= threeDaysFromNow && deliveryDate >= today;
                
                return isOverdue || isWithin3Days;
            });
            
            // Sort by delivery date (soonest/overdue first)
            emergencyOrders.sort((a, b) => {
                const dateA = new Date(a.deliveryDate);
                const dateB = new Date(b.deliveryDate);
                return dateA - dateB;
            });
            
            if (emergencyOrders.length === 0) {
                emergencySection.style.display = 'none';
                return;
            }
            
            emergencySection.style.display = 'block';
            
            emergencyList.innerHTML = emergencyOrders.map(o => {
                const today = new Date();
                const delivery = new Date(o.deliveryDate);
                const diffTime = delivery - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                let urgencyLevel = '';
                if (diffDays < 0) {
                    urgencyLevel = `üö® <span style="color:red; font-weight:bold;">OVERDUE BY ${Math.abs(diffDays)} DAYS!</span>`;
                } else if (diffDays === 0) {
                    urgencyLevel = `üî• <span style="color:red; font-weight:bold;">DUE TODAY!</span>`;
                } else if (diffDays === 1) {
                    urgencyLevel = `‚ö†Ô∏è <span style="color:orange; font-weight:bold;">DUE TOMORROW!</span>`;
                } else {
                    urgencyLevel = `‚ö†Ô∏è <span style="color:orange;">Due in ${diffDays} days</span>`;
                }
                
                return `
                    <div class="order-item-card priority-high">
                        <strong>${o.customerName}</strong> - ${o.customerPhone}<br>
                        Order #${o.id.toString().slice(-6)} | Delivery: ${o.deliveryDate}<br>
                        ${urgencyLevel}<br>
                        Items: ${o.items.map(i => `${i.type} (x${i.quantity || 1})`).join(', ')}<br>
                        <div style="margin-top:10px;">
                            <button class="btn btn-success btn-small" onclick="completeOrder(${o.id})">Mark Completed</button>
                            <button class="btn btn-warning btn-small" onclick="editExistingOrder(${o.id})">Edit</button>
                            <button class="btn btn-secondary btn-small" onclick="viewOrderDetails(${o.id})">Details</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show Emergency Orders Modal
        function showEmergencyOrders() {
            // Update the section in search tab
            const emergencySection = document.getElementById('emergencyOrdersSection');
            const emergencyList = document.getElementById('emergencyOrdersList');
            
            // Get today and 3 days from now
            const today = new Date();
            const threeDaysFromNow = new Date();
            threeDaysFromNow.setDate(today.getDate() + 3);
            
            // Find emergency orders (pending, due within 3 days, or overdue)
            const emergencyOrders = orders.filter(o => {
                if (o.status !== 'pending') return false;
                if (!o.deliveryDate) return false;
                
                const deliveryDate = new Date(o.deliveryDate);
                const isOverdue = deliveryDate < today;
                const isWithin3Days = deliveryDate <= threeDaysFromNow && deliveryDate >= today;
                
                return isOverdue || isWithin3Days;
            });
            
            // Sort by delivery date (soonest/overdue first)
            emergencyOrders.sort((a, b) => {
                const dateA = new Date(a.deliveryDate);
                const dateB = new Date(b.deliveryDate);
                return dateA - dateB;
            });
            
            if (emergencyOrders.length === 0) {
                emergencySection.style.display = 'none';
                return;
            }
            
            emergencySection.style.display = 'block';
            
            emergencyList.innerHTML = emergencyOrders.map(o => {
                const today = new Date();
                const delivery = new Date(o.deliveryDate);
                const diffTime = delivery - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                let urgencyLevel = '';
                if (diffDays < 0) {
                    urgencyLevel = `üö® <span style="color:red; font-weight:bold;">OVERDUE BY ${Math.abs(diffDays)} DAYS!</span>`;
                } else if (diffDays === 0) {
                    urgencyLevel = `üî• <span style="color:red; font-weight:bold;">DUE TODAY!</span>`;
                } else if (diffDays === 1) {
                    urgencyLevel = `‚ö†Ô∏è <span style="color:orange; font-weight:bold;">DUE TOMORROW!</span>`;
                } else {
                    urgencyLevel = `‚ö†Ô∏è <span style="color:orange;">Due in ${diffDays} days</span>`;
                }
                
                return `
                    <div class="order-item-card priority-high">
                        <strong>${o.customerName}</strong> - ${o.customerPhone}<br>
                        Order #${o.id.toString().slice(-6)} | Delivery: ${o.deliveryDate}<br>
                        ${urgencyLevel}<br>
                        Items: ${o.items.map(i => `${i.type} (x${i.quantity || 1})`).join(', ')}<br>
                        <div style="margin-top:10px;">
                            <button class="btn btn-success btn-small" onclick="completeOrder(${o.id})">Mark Completed</button>
                            <button class="btn btn-warning btn-small" onclick="editExistingOrder(${o.id})">Edit</button>
                            <button class="btn btn-secondary btn-small" onclick="viewOrderDetails(${o.id})">Details</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Open Emergency Orders Modal
        function showEmergencyOrdersModal() {
            const today = new Date();
            const threeDaysFromNow = new Date();
            threeDaysFromNow.setDate(today.getDate() + 3);
            
            // Find emergency orders
            const emergencyOrders = orders.filter(o => {
                if (o.status !== 'pending') return false;
                if (!o.deliveryDate) return false;
                
                const deliveryDate = new Date(o.deliveryDate);
                const isOverdue = deliveryDate < today;
                const isWithin3Days = deliveryDate <= threeDaysFromNow && deliveryDate >= today;
                
                return isOverdue || isWithin3Days;
            });
            
            // Sort by delivery date
            emergencyOrders.sort((a, b) => {
                const dateA = new Date(a.deliveryDate);
                const dateB = new Date(b.deliveryDate);
                return dateA - dateB;
            });
            
            const emergencyModalList = document.getElementById('emergencyModalList');
            
            if (emergencyOrders.length === 0) {
                emergencyModalList.innerHTML = '<div class="empty-state">No emergency orders found!</div>';
            } else {
                emergencyModalList.innerHTML = emergencyOrders.map(o => {
                    const today = new Date();
                    const delivery = new Date(o.deliveryDate);
                    const diffTime = delivery - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    let urgencyLevel = '';
                    if (diffDays < 0) {
                        urgencyLevel = `üö® <span style="color:red; font-weight:bold;">OVERDUE BY ${Math.abs(diffDays)} DAYS!</span>`;
                    } else if (diffDays === 0) {
                        urgencyLevel = `üî• <span style="color:red; font-weight:bold;">DUE TODAY!</span>`;
                    } else if (diffDays === 1) {
                        urgencyLevel = `‚ö†Ô∏è <span style="color:orange; font-weight:bold;">DUE TOMORROW!</span>`;
                    } else {
                        urgencyLevel = `‚ö†Ô∏è <span style="color:orange;">Due in ${diffDays} days</span>`;
                    }
                    
                    return `
                        <div class="order-item-card priority-high">
                            <strong>${o.customerName}</strong> - ${o.customerPhone}<br>
                            Order #${o.id.toString().slice(-6)} | Delivery: ${o.deliveryDate}<br>
                            ${urgencyLevel}<br>
                            Items: ${o.items.map(i => `${i.type} (x${i.quantity || 1})`).join(', ')}<br>
                            <div style="margin-top:10px;">
                                <button class="btn btn-success btn-small" onclick="completeOrder(${o.id}); closeModal('emergencyOrdersModal');">Mark Completed</button>
                                <button class="btn btn-warning btn-small" onclick="editExistingOrder(${o.id}); closeModal('emergencyOrdersModal');">Edit</button>
                                <button class="btn btn-secondary btn-small" onclick="viewOrderDetails(${o.id});">Details</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            openModal('emergencyOrdersModal');
        }

        // View Order Details
        function viewOrderDetails(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            const customer = customers.find(c => c.id == order.customerId);
            
            let detailsHTML = `
                <h3>Order Details</h3>
                <p><strong>Customer:</strong> ${order.customerName} (${order.customerPhone})</p>
                <p><strong>Order ID:</strong> ${order.id}</p>
                <p><strong>Delivery Date:</strong> ${order.deliveryDate}</p>
                <p><strong>Priority:</strong> ${order.priority || 'medium'}</p>
                <p><strong>Status:</strong> ${order.status}</p>
                <p><strong>Created:</strong> ${order.created}</p>
                ${order.notes ? `<p><strong>Notes:</strong> ${order.notes}</p>` : ''}
                
                <h4>Items:</h4>
            `;
            
            order.items.forEach((item, index) => {
                detailsHTML += `
                    <div class="order-item-card">
                        <strong>${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</strong>
                        <p>Quantity: ${item.quantity || 1}</p>
                        ${item.note ? `<p>Note: ${item.note}</p>` : ''}
                        <p>Added: ${item.addedAt || ''}</p>
                    </div>
                `;
            });
            
            // Show customer measurements if available
            if (customer) {
                detailsHTML += `<h4>Customer Measurements:</h4>`;
                
                if (customer.kurti && (customer.kurti.length || customer.kurti.chest)) {
                    detailsHTML += `<div class="measurement-section">
                        <div class="section-title">Kurti Measurements</div>
                        ${customer.kurti.length ? `<p><strong>Length:</strong> ${customer.kurti.length}</p>` : ''}
                        ${customer.kurti.chest ? `<p><strong>Chest:</strong> ${customer.kurti.chest}</p>` : ''}
                        ${customer.kurti.waist ? `<p><strong>Waist:</strong> ${customer.kurti.waist}</p>` : ''}
                        ${customer.kurti.hips ? `<p><strong>Hips:</strong> ${customer.kurti.hips}</p>` : ''}
                        ${customer.kurti.shoulder ? `<p><strong>Shoulder:</strong> ${customer.kurti.shoulder}</p>` : ''}
                        ${customer.kurti.sleeves ? `<p><strong>Sleeves:</strong> ${customer.kurti.sleeves}</p>` : ''}
                        ${customer.kurti.neck ? `<p><strong>Neck:</strong> ${customer.kurti.neck}</p>` : ''}
                        ${customer.kurti.cut ? `<p><strong>Cut:</strong> ${customer.kurti.cut}</p>` : ''}
                        ${customer.kurti.gher ? `<p><strong>Gher:</strong> ${customer.kurti.gher}</p>` : ''}
                    </div>`;
                }
                
                if (customer.salwar && (customer.salwar.length || customer.salwar.mori)) {
                    detailsHTML += `<div class="measurement-section">
                        <div class="section-title">Salwar Measurements</div>
                        ${customer.salwar.mori ? `<p><strong>Mori:</strong> ${customer.salwar.mori}</p>` : ''}
                        ${customer.salwar.length ? `<p><strong>Length:</strong> ${customer.salwar.length}</p>` : ''}
                        ${customer.salwar.pindi ? `<p><strong>Pindi:</strong> ${customer.salwar.pindi}</p>` : ''}
                        ${customer.salwar.knee ? `<p><strong>Knee:</strong> ${customer.salwar.knee}</p>` : ''}
                        ${customer.salwar.thai ? `<p><strong>Thai:</strong> ${customer.salwar.thai}</p>` : ''}
                        ${customer.salwar.deep_thai ? `<p><strong>Deep Thai:</strong> ${customer.salwar.deep_thai}</p>` : ''}
                    </div>`;
                }
                
                if (customer.blouse && (customer.blouse.length || customer.blouse.chest)) {
                    detailsHTML += `<div class="measurement-section">
                        <div class="section-title">Blouse Measurements</div>
                        ${customer.blouse.length ? `<p><strong>Length:</strong> ${customer.blouse.length}</p>` : ''}
                        ${customer.blouse.upper_chest ? `<p><strong>Upper Chest:</strong> ${customer.blouse.upper_chest}</p>` : ''}
                        ${customer.blouse.chest ? `<p><strong>Chest:</strong> ${customer.blouse.chest}</p>` : ''}
                        ${customer.blouse.kamar ? `<p><strong>Kamar:</strong> ${customer.blouse.kamar}</p>` : ''}
                        ${customer.blouse.shoulder ? `<p><strong>Shoulder:</strong> ${customer.blouse.shoulder}</p>` : ''}
                        ${customer.blouse.sleeves ? `<p><strong>Sleeves:</strong> ${customer.blouse.sleeves}</p>` : ''}
                        ${customer.blouse.neck ? `<p><strong>Neck:</strong> ${customer.blouse.neck}</p>` : ''}
                    </div>`;
                }
            }
            
            // Create a modal to show details
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'viewOrderModal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Order #${orderId.toString().slice(-6)}</h3>
                        <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        ${detailsHTML}
                        <div style="text-align:center; margin-top:20px;">
                            ${order.status === 'pending' ? 
                                `<button class="btn btn-warning" onclick="editExistingOrder(${order.id}); this.parentElement.parentElement.parentElement.remove()">Edit Order</button>` : ''
                            }
                            <button class="btn btn-primary" onclick="this.parentElement.parentElement.parentElement.remove()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Billing Process
        function startBillingProcess(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            currentBillingOrder = order;
            currentBillingItemIndex = 0;
            billingData = {
                orderId: order.id,
                customerName: order.customerName,
                customerPhone: order.customerPhone,
                items: []
            };
            
            billNextItem();
        }

        function billNextItem() {
            if (currentBillingItemIndex >= currentBillingOrder.items.length) {
                showFinalBill();
                return;
            }
            
            const item = currentBillingOrder.items[currentBillingItemIndex];
            document.getElementById('currentItemTitle').textContent = 
                `${item.type.charAt(0).toUpperCase() + item.type.slice(1)}`;
            
            let billingForm = `
                <div class="billing-item">
                    <h4>${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</h4>
                    
                    <label>üì∏ Take Photo of Finished Item</label><br>
                    <button class="btn-small" onclick="document.getElementById('finishedPhoto_${currentBillingItemIndex}').click()">Take Photo</button>
                    <input type="file" id="finishedPhoto_${currentBillingItemIndex}" accept="image/*" capture="environment" style="display:none;" onchange="previewPhoto(this, ${currentBillingItemIndex})">
                    <div id="photoPreview_${currentBillingItemIndex}"></div>
                    
                    <div style="margin-top:20px;">
                        <label>Price for this Item (‚Çπ)</label>
                        <input type="number" id="itemPrice_${currentBillingItemIndex}" min="0" value="0" style="font-size:1.2rem; padding:15px; width:100%;">
                    </div>
                </div>
            `;
            
            document.getElementById('itemBillingContent').innerHTML = billingForm;
            openModal('itemBillingModal');
        }

        function previewPhoto(input, index) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById(`photoPreview_${index}`).innerHTML = 
                        `<img src="${e.target.result}" class="photo-preview">`;
                };
                reader.readAsDataURL(file);
            }
        }

        function saveItemBilling() {
            const item = currentBillingOrder.items[currentBillingItemIndex];
            const price = parseFloat(document.getElementById(`itemPrice_${currentBillingItemIndex}`).value) || 0;
            
            if (price <= 0) {
                alert('Please enter a valid price');
                return;
            }
            
            let finishedPhoto = null;
            const photoInput = document.getElementById(`finishedPhoto_${currentBillingItemIndex}`);
            if (photoInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    finishedPhoto = e.target.result;
                    saveBillingData(price, finishedPhoto);
                };
                reader.readAsDataURL(photoInput.files[0]);
            } else {
                saveBillingData(price, null);
            }
        }

        function saveBillingData(price, finishedPhoto) {
            const item = currentBillingOrder.items[currentBillingItemIndex];
            const total = price * (item.quantity || 1);
            
            billingData.items.push({
                type: item.type,
                quantity: item.quantity || 1,
                price: price,
                total: total,
                finishedPhoto: finishedPhoto
            });
            
            currentBillingItemIndex++;
            closeModal('itemBillingModal');
            
            if (currentBillingItemIndex < currentBillingOrder.items.length) {
                setTimeout(billNextItem, 300);
            } else {
                setTimeout(showFinalBill, 300);
            }
        }

        function showFinalBill() {
            // Update order status to billed
            const orderIndex = orders.findIndex(o => o.id === currentBillingOrder.id);
            if (orderIndex !== -1) {
                orders[orderIndex].status = 'billed';
                orders[orderIndex].billedAt = new Date().toISOString();
                localStorage.setItem('tailor_orders', JSON.stringify(orders));
            }
            
            let grandTotal = 0;
            // Simple bill without shop name
            let billHTML = `
                <div style="margin-bottom:30px;">
                    <div class="bill-row bill-header">
                        <div>Item</div>
                        <div>Price</div>
                    </div>
            `;
            
            billingData.items.forEach((item, index) => {
                grandTotal += item.total;
                
                billHTML += `
                    <div class="bill-row">
                        <div>
                            <strong>${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</strong>
                            ${item.finishedPhoto ? `<br><img src="${item.finishedPhoto}" class="photo-preview">` : ''}
                        </div>
                        <div>‚Çπ${item.total}</div>
                    </div>
                `;
            });
            
            billHTML += `
                    <div class="bill-row bill-total">
                        <div>TOTAL AMOUNT</div>
                        <div>‚Çπ${grandTotal}</div>
                    </div>
                </div>
                
                <div style="text-align:center; margin-top:30px;">
                    <button class="btn btn-primary" onclick="printFinalBill()" style="font-size:1.1rem; padding:15px 30px;">üñ®Ô∏è Print Bill</button>
                </div>
            `;
            
            document.getElementById('finalBillContent').innerHTML = billHTML;
            openModal('finalBillingModal');
        }

        function printFinalBill() {
            const printContent = document.getElementById('finalBillContent').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = `
                <div style="padding:20px; font-family:Arial, sans-serif;">
                    ${printContent}
                </div>
            `;
            
            window.print();
            document.body.innerHTML = originalContent;
            location.reload();
        }

        // Open All Orders Modal - FIXED VERSION
        function openAllOrdersModal() {
            openModal('allOrdersModal');
            filterModalOrders('pending');
        }

        function filterModalOrders(status) {
            if (status) {
                // Update active tab
                document.querySelectorAll('#allOrdersModal .sub-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                event.target.classList.add('active');
            } else {
                status = document.querySelector('#allOrdersModal .sub-tab.active').getAttribute('onclick').match(/'([^']+)'/)[1];
            }
            
            const term = document.getElementById('ordersSearch').value.toLowerCase();
            const list = document.getElementById('allOrdersList');
            
            // Filter orders by status first
            let filteredOrders = orders.filter(o => o.status === status);
            
            // Then apply search term if exists
            if (term) {
                filteredOrders = filteredOrders.filter(o => 
                    (o.customerName && o.customerName.toLowerCase().includes(term)) || 
                    (o.customerPhone && o.customerPhone.includes(term))
                );
            }
            
            // Sort by priority and delivery date
            filteredOrders.sort((a, b) => {
                // First sort by priority
                const priorityOrder = { 'high': 3, 'medium': 2, 'low': 1 };
                const priorityDiff = (priorityOrder[b.priority] || 1) - (priorityOrder[a.priority] || 1);
                
                if (priorityDiff !== 0) return priorityDiff;
                
                // Then sort by delivery date (soonest first)
                const dateA = new Date(a.deliveryDate);
                const dateB = new Date(b.deliveryDate);
                return dateA - dateB;
            });
            
            if (filteredOrders.length === 0) {
                list.innerHTML = '<div class="empty-state">No orders found</div>';
                return;
            }
            
            list.innerHTML = filteredOrders.map(o => {
                // Calculate days until delivery for pending orders
                let daysUntil = '';
                let priorityClass = '';
                if (o.status === 'pending' && o.deliveryDate) {
                    const today = new Date();
                    const delivery = new Date(o.deliveryDate);
                    const diffTime = delivery - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays < 0) {
                        daysUntil = ` <span style="color:red; font-weight:bold;">(${Math.abs(diffDays)} days overdue!)</span>`;
                    } else if (diffDays <= 3) {
                        daysUntil = ` <span style="color:orange; font-weight:bold;">(${diffDays} days left)</span>`;
                    }
                    priorityClass = `priority-${o.priority || 'medium'}`;
                }
                
                return `
                    <div class="order-item-card ${priorityClass}">
                        <strong>${o.customerName}</strong> - ${o.customerPhone}<br>
                        Order #${o.id.toString().slice(-6)} | Delivery: ${o.deliveryDate}${daysUntil}<br>
                        ${o.priority ? `Priority: <strong>${o.priority.toUpperCase()}</strong><br>` : ''}
                        Items: ${o.items.map(i => i.type).join(', ')}<br>
                        <div style="margin-top:10px;">
                            ${o.status === 'pending' ? 
                                `<button class="btn btn-success btn-small" onclick="completeOrder(${o.id}); closeModal('allOrdersModal');">Mark Completed</button>
                                 <button class="btn btn-warning btn-small" onclick="editExistingOrder(${o.id}); closeModal('allOrdersModal');">Edit Order</button>` :
                                o.status === 'completed' ?
                                `<button class="btn btn-primary btn-small" onclick="startBillingProcess(${o.id}); closeModal('allOrdersModal');">Generate Bill</button>` : ''
                            }
                            <button class="btn btn-secondary btn-small" onclick="viewOrderDetails(${o.id});">View Details</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Open Billing Modal
        function openBillingModal() {
            const completedOrders = orders.filter(o => o.status === 'completed');
            const list = document.getElementById('billingOrdersList');
            
            if (completedOrders.length === 0) {
                list.innerHTML = '<div class="empty-state">No completed orders to bill</div>';
                openModal('billingModal');
                return;
            }
            
            let html = '<h4>Select Order to Bill</h4>';
            completedOrders.forEach(order => {
                html += `
                    <div class="order-item-card">
                        <strong>${order.customerName} - ${order.customerPhone}</strong><br>
                        Order #${order.id.toString().slice(-6)} | Items: ${order.items.map(i => i.type).join(', ')}<br>
                        <button class="btn btn-primary btn-small" style="margin-top:10px;" onclick="startBillingProcess(${order.id}); closeModal('billingModal')">Generate Bill</button>
                    </div>
                `;
            });
            
            list.innerHTML = html;
            openModal('billingModal');
        }

        // Modal functions
        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function updateUrgentAlert() {
            const soon = new Date();
            soon.setDate(soon.getDate() + 3);
            const urgent = orders.filter(o => o.status === 'pending' && new Date(o.deliveryDate) <= soon).length;
            const alert = document.getElementById('urgentAlert');
            document.getElementById('urgentCount').textContent = urgent;
            alert.style.display = urgent > 0 ? 'block' : 'none';
        }
    </script>
</body>
</html>